{% extends "base.html" %}
{% load tournament_extras %}

{% block title %}Stats - {{ season.name }} - {{ league.name }}{% endblock %}

{% block nav_tv %}active{% endblock %}
{% load staticfiles tournament_extras %}

{% block css %}
<link rel="stylesheet" href="{% static 'lib/css/cg_base.css' %}">
<link rel="stylesheet" href="{% static 'lib/css/cg_theme.css' %}">
<link rel="stylesheet" href="{% static 'lib/css/tv.css' %}">
{% endblock %}

{% block head_js %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="{% static 'lib/js/chessground.js' %}"></script>
<script type="text/javascript" src="{% static 'lib/js/jquery-3.1.0.min.js' %}"></script>
<script type="text/javascript" src="{% static 'lib/js/chess.min.js' %}"></script>
<script>
  var chessGrounds = null;
  var ws = null;
  var queue = [];

  function send (ws, message) {
    if(ws.readyState === 1) {
      ws.send(message);
    }
    else {
      queue.push(message);
    }
  }

  function pingNow() {
    send(ws, '{"t":"p"}');
  };

  function run () {
    chessGrounds = {};
    const baseURL = 'wss://socket.lichess.org';
    const endpoint = '/socket';
    const url = baseURL + endpoint + '?sri=' + Math.random().toString(36).substring(2)
    ws = new WebSocket(url);

    ws.onopen = function () {
      pingNow();
      while(queue.length > 0) {
        let message = queue.pop();
        console.log(ws);
        ws.send(message);
        console.log(message);
      }
    }

    ws.onerror = function (error) {
      console.log('error');
      console.log(error);
    }

    ws.onmessage = function (e) {
      console.log(e);
      const m = JSON.parse(e.data);

      if(m.t === 'fen') {
        let ground = chessGrounds[m.d.id];
        ground.set(m.d);
      }
      else if(m.t === 'n') {
        setTimeout(pingNow, 2000);
      }
    }
  }

  run();

  function newBoard(gameId) {
    var ground;
    var chess = new Chess();

    ground = Chessground(document.getElementById('ground7'), {
      viewOnly: true,
      turnColor: 'white',
      animation: {
        duration: 500
      },
      movable: {
        free: false,
        color: null,
        premove: true,
        dests: {},
        events: {
          after: null
        }
      },
      drawable: {
        enabled: true
      }
    });

    chessGrounds[gameId] = ground;

    $.ajax({
      url:'https://en.lichess.org/api/game/' + gameId,
      data: {
        with_fens: 1
      },
      dataType:'jsonp',
      jsonp:'callback',
      success: function(data) {
        let a = {};
        a.fen = data.fens[data.fens.length-1];
        ground.set(a);
        const label = data.players.white.userId + ' (' + data.players.white.rating + ') vs. ' + data.players.black.userId + ' (' + data.players.black.rating + ')';
        console.log(data);
        $('#label_2c3PpJKT').html(label);
      }
    });

    let message = JSON.stringify({
      t: 'startWatching',
      d: gameId
    })
    send(ws, message);

    setInterval(function() { console.log(ws.readyState)}, 1000);
  };
</script>
{% endblock %}

{% block content %}
<div class="row row-condensed-xs">
	<div class="col-md-12">
		<div class="well">
			<div class="well-head">
				<h3>Games in Play</h3>
			</div>
			<div class="well-body">
        <section>
            <div class="chessground small wood cburnett" id="ground7">
              <script>
                newBoard('2c3PpJKT');
              </script>
            </div>
            <div id="label_2c3PpJKT" class="gameLabel">

            </div>
        </section>
			</div>
		</div>
	</div>
</div>
{% endblock %}
